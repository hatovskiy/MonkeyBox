const tg = window.Telegram.WebApp;
tg.expand();

let userId = null;
let currentGame = null;
let gameCheckInterval = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    userId = urlParams.get('user');

    if (!userId) {
        showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        return;
    }

    // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ TG)
    const username = tg.initDataUnsafe?.user?.username || '–ò–≥—Ä–æ–∫';
    document.getElementById('username').textContent = username;

    updateBalance();
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
async function updateBalance() {
    try {
        const response = await fetch(`/api/user/${userId}`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('balance').textContent = `${data.user.balance} TON`;
        }
    } catch (error) {
        console.error('Error updating balance:', error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã
function createGame() {
    hideAllScreens();
    document.getElementById('create-game').classList.remove('hidden');
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ
function joinGame() {
    hideAllScreens();
    document.getElementById('join-game').classList.remove('hidden');
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã
async function submitCreateGame() {
    const betAmount = parseFloat(document.getElementById('bet-amount').value);

    if (isNaN(betAmount) || betAmount < 0.5) {
        tg.showAlert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 0.5 TON');
        return;
    }

    try {
        const response = await fetch('/api/create-game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, betAmount })
        });

        const data = await response.json();

        if (data.success) {
            currentGame = data.gameId;
            showWaitingRoom(data.gameId, betAmount);
            startGameCheck();
        } else {
            tg.showAlert(data.error);
        }
    } catch (error) {
        tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã');
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ
async function submitJoinGame() {
    const gameId = document.getElementById('game-id').value.trim();

    if (!gameId) {
        tg.showAlert('–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã');
        return;
    }

    try {
        const response = await fetch('/api/join-game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, gameId })
        });

        const data = await response.json();

        if (data.success) {
            currentGame = gameId;
            showGameRoom(data.game);
            startGameCheck();
        } else {
            tg.showAlert(data.error);
        }
    } catch (error) {
        tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –æ–∂–∏–¥–∞–Ω–∏—è
function showWaitingRoom(gameId, betAmount) {
    hideAllScreens();
    document.getElementById('waiting-room').classList.remove('hidden');
    document.getElementById('waiting-game-id').textContent = gameId;
    document.getElementById('waiting-bet').textContent = betAmount;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
function showGameRoom(game) {
    hideAllScreens();
    document.getElementById('game-room').classList.remove('hidden');
    document.getElementById('game-bet').textContent = game.betAmount;
    document.getElementById('opponent-name').textContent = '–ò–≥—Ä–æ–∫ 2';
    currentGame = game.id;
}

// –°–¥–µ–ª–∞—Ç—å –≤—ã–±–æ—Ä
async function makeChoice(choice) {
    try {
        const response = await fetch('/api/make-choice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, gameId: currentGame, choice })
        });

        const data = await response.json();

        if (data.success) {
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.disabled = true;
            });

            if (data.game.status === 'finished') {
                showResult(data.game);
            } else {
                document.getElementById('waiting-choice').classList.remove('hidden');
            }
        }
    } catch (error) {
        tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
function showResult(game) {
    hideAllScreens();
    document.getElementById('result-room').classList.remove('hidden');

    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');
    const resultCard = document.getElementById('result-card');

    let playerChoice = game.player1 === parseInt(userId) ? game.player1Choice : game.player2Choice;
    let opponentChoice = game.player1 === parseInt(userId) ? game.player2Choice : game.player1Choice;

    const choicesEmoji = {
        rock: 'ü™®',
        paper: 'üìÑ',
        scissors: '‚úÇÔ∏è'
    };

    if (game.winner === 'draw') {
        resultTitle.textContent = 'ü§ù –ù–∏—á—å—è!';
        resultMessage.textContent = `${choicesEmoji[playerChoice]} vs ${choicesEmoji[opponentChoice]}`;
        resultCard.className = 'result-card draw';
    } else if (game.winner === parseInt(userId)) {
        resultTitle.textContent = 'üéâ –ü–æ–±–µ–¥–∞!';
        resultMessage.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${game.betAmount * 2} TON!`;
        resultCard.className = 'result-card win';
    } else {
        resultTitle.textContent = 'üòî –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
        resultMessage.textContent = `–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ ${game.betAmount} TON`;
        resultCard.className = 'result-card lose';
    }

    updateBalance();
    stopGameCheck();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã
function startGameCheck() {
    gameCheckInterval = setInterval(async () => {
        if (!currentGame) return;

        try {
            const response = await fetch(`/api/game/${currentGame}`);
            const data = await response.json();

            if (data.success) {
                const game = data.game;

                if (game.status === 'active' && document.getElementById('waiting-room') && !document.getElementById('waiting-room').classList.contains('hidden')) {
                    showGameRoom(game);
                }

                if (game.status === 'finished') {
                    showResult(game);
                }
            }
        } catch (error) {
            console.error('Error checking game:', error);
        }
    }, 2000);
}

function stopGameCheck() {
    if (gameCheckInterval) {
        clearInterval(gameCheckInterval);
        gameCheckInterval = null;
    }
}

// –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞
function playAgain() {
    currentGame = null;
    backToMenu();
}

// –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
function backToMenu() {
    showMainMenu();
    stopGameCheck();
    currentGame = null;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (—Å–µ—Ç–∫—É –∏–≥—Ä)
function showMainMenu() {
    hideAllScreens();
    document.getElementById('game-menu').classList.remove('hidden');
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.nav-item').classList.add('active');
}

// –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
function hideAllScreens() {
    document.getElementById('game-menu').classList.add('hidden');
    document.getElementById('create-game').classList.add('hidden');
    document.getElementById('join-game').classList.add('hidden');
    document.getElementById('waiting-room').classList.add('hidden');
    document.getElementById('game-room').classList.add('hidden');
    document.getElementById('result-room').classList.add('hidden');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
function showError(message) {
    tg.showAlert(message);
}